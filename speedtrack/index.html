<html>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script src="js/leaflet.js"></script>
	<script src="js/coords.js"></script>
	<script src="js/leaflet.hotline.js"></script>
	<script src="js/yandex.js"></script>
	<script src="js/gpx.min_075.js"></script>
	<script src="js/leaflet.polylineDecorator.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
	<style>		
		body { padding: 0 0 0 0; margin: 0px; }
		#map {width: 100%; height: 100%; padding: 0px; margin: 0px; }
		#top {width: 400px; height:24px; position: absolute; left: 70px; top: 8px; z-index: 1001; font-weight: bold; }
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="top"></div>
	<script>
		var tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png');
		var map = L.map('map', {layers: [tiles], scrollWheelZoom: true, dragging: true, tap: false });		
		map.setView(new L.LatLng(50.55,37.55), 8);
		
		var osmgerman = L.tileLayer('http://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Maps &copy; <a href="http://openstreetmap.org">OSM</a>', subdomains: ['a','b','c'] });		
		var osmhot = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Maps &copy; <a href="http://openstreetmap.org">OSM</a>', subdomains: ['a','b','c'] });		
		var opentopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var cyclemap = L.tileLayer('https://{s}.tile.hosted.thunderforest.com/cycle/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var mtbmap = L.tileLayer('https://tile.mtbmap.cz/mtbmap_tiles/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var outdoor = L.tileLayer('https://a.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var dvagis = L.tileLayer('https://tile{s}.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=1.1', { maxZoom: 18, subdomains: ['0','1','2','3'] });			
		var thunderforest = L.tileLayer('https://a.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', { maxZoom: 18, subdomains: ['a','b','c'] });	
		
		var osmWikiMapTiles = L.tileLayer('', { maxZoom: 17, attribution: 'Maps &copy; WikiMapia' });
		osmWikiMapTiles.getTileUrl = function (tilePoint, zoom) { return "http://i" + ((tilePoint.x % 4) + (tilePoint.y % 4)*4) + ".wikimapia.org/?lng=1&" + 'x=' + tilePoint.x + '&y='+tilePoint.y+'&zoom='+tilePoint.z; };
		
		var GoogleMapLayer = new L.TileLayer('http://{s}.google.com/vt/lyrs=m@177000000&hl=ru&src=app&x={x}&s=&y={y}&z={z}&s=Ga', {attribution: 'Data, imagery and map information provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], zIndex: 2});
		var GoogleMapOverlayLayer = new L.TileLayer('http://{s}.google.com/vt/lyrs=h@177000000&hl=ru&src=app&x={x}&s=&y={y}&z={z}&s=G', {attribution: 'Data, imagery and map information provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], zIndex: 4});
		var GoogleTrafficLayer = new L.TileLayer('http://{s}.google.com/vt?hl=ru&src=app&lyrs=m@177000000,traffic|seconds_into_week:-1&x={x}&s=&y={y}&z={z}&style=15', {attribution: 'Traffic data provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], traffic: true, zIndex: 21});
		
		var ESRI = new L.TileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png', { attribution: ' © <a href="https://www.arcgis.com/features/">ArcGIS</a>', lttype: 'ESRI' });
		var ESRISat = new L.TileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png', { attribution: ' © <a href="https://arcgisonline.com">ArcGIS</a>', lttype: 'ESRISat' });
		
		var basemaps = {					
					  "OSM Mapnik": tiles, 
					  "OSM German Style": osmgerman, 
					  "OSM Hot Style": osmhot,
					  'OpenTopoMap': opentopo,
					  'OpenCycleMap': cyclemap,
					  'MTB': mtbmap,
					  'Outdoor': outdoor,
					  "2GIS": dvagis,
					  "ThunderForest": thunderforest,
					  "WikiMapia": osmWikiMapTiles,
					  "Google (Maps)": GoogleMapLayer,
					  'ArcGIS ESRI (Maps)': ESRI, 
					  'ArcGIS ESRI (Sattelite)': ESRISat, 
				  };
		var overlays = {
					  "Google (Hybrid)": GoogleMapOverlayLayer,
					  "Google (Traffic)": GoogleTrafficLayer,				  
				  };
		L.control.layers(basemaps, overlays, { collapsed: true }).addTo(map);		
		var control = L.control.layers(null, null, { collapsed: false }).addTo(map);
		
		
		var hash = window.location.hash.substr(1);
		if (hash != '' && hash.length == 4)
		{		
			// https://allorigins.win/
			var url = 'http://xtrex.ru/json/' + hash + '.json';
			$.getJSON('https://api.allorigins.win/get?url=' + encodeURIComponent(url), function (data) 
			{
			   var jObj = JSON.parse(data.contents).tracks;
			   var pts = jObj[0].points;
			   
			   coords = [];
			   for (let i = 0; i < pts.length; i++)
			   {
					if(coords.length < 4) coords.push([pts[i][0],pts[i][1],0]);
					else coords.push([pts[i][0],pts[i][1],pts[i][4]]);
			   };
			   
			   var hotlineLayer = L.hotline(coords, { min: 0, max: 150,
				  palette: { 0.0: '#FF0000', 0.25: '#FFFF00', 0.45: '#00FF00', 0.6: '#C0FF00', 0.75: '#A2D2FF', 0.9: '#BDE0FE', 1.0: '#EDF2F4' },
				  weight: 8, outlineColor: '#000000', outlineWidth: 1
			   });
				
			   var bounds = hotlineLayer.getBounds();
			   map.fitBounds(bounds);
			   hotlineLayer.addTo(map);
			   control.addOverlay(hotlineLayer, jObj[0].name);
			   
			   hotlineLayer.on('click', function (e) {
					let lp = e.layerPoint;
					$('#top').text(e.latlng.toString() + ' + ' + lp.toString());
					let np = findNearestPoint(pts,[e.latlng.lat,e.latlng.lng]);
					$('#top').text('Speed: ~' + (np[4]).toString() + ' km/h');
			   });
			  
			   var decorator = L.polylineDecorator(hotlineLayer, {
					patterns: [{offset: 0, repeat: 30, symbol: L.Symbol.arrowHead({pixelSize: 7, pathOptions: { fillOpacity: 0.75, weight: 0, color: 'black' }})}]
			   });
			   decorator.addTo(map);
			   control.addOverlay(decorator, jObj[0].name + ' <b>&gt;</b>');
									
			   L.circleMarker([coords[0][0], coords[0][1]], { radius: 10, fillColor: '#600000', fillOpacity: 1,  color: '#fff', weight: 2, }).addTo(map);
			   L.circleMarker([coords[coords.length-1][0], coords[coords.length-1][1]], { radius: 10, fillColor: '#009000', fillOpacity: 1,  color: '#fff', weight: 2, }).addTo(map);
			});
		};
		
		var findNearestPoint = function(points, point)
		{
			let rdd = Infinity, rpt = 0;
			for (let i = 0; i < points.length; i++)
			{
				let cdd = Math.abs(points[i][0] - point[0]) +  Math.abs(points[i][1] - point[1]);
				if (cdd < rdd) { rdd = cdd; rpt = i; };
				if (cdd == 0) break;
			};
			return points[rpt];
		};
	</script>
</body>
</html>