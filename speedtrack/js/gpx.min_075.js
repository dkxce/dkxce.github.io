var L=L||require("leaflet"),_MAX_POINT_INTERVAL_MS=15e3,_SECOND_IN_MILLIS=1e3,_MINUTE_IN_MILLIS=60*_SECOND_IN_MILLIS,_HOUR_IN_MILLIS=60*_MINUTE_IN_MILLIS,_DAY_IN_MILLIS=24*_HOUR_IN_MILLIS,_GPX_STYLE_NS="http://www.topografix.com/GPX/gpx_style/0/2",_DEFAULT_ICON=new L.Icon.Default,_DEFAULT_MARKERS={startIcon:_DEFAULT_ICON,endIcon:_DEFAULT_ICON,wptIcons:{"":_DEFAULT_ICON},wptTypeIcons:{"":_DEFAULT_ICON},pointMatchers:[]},_DEFAULT_MARKER_OPTS={iconSize:[33,45],iconAnchor:[16,45],clickable:!1},_DEFAULT_POLYLINE_OPTS={color:"blue"},_DEFAULT_GPX_OPTS={parseElements:["track","route","waypoint"],joinTrackSegments:!0};L.GPX=L.FeatureGroup.extend({initialize:function(t,e){e.max_point_interval=e.max_point_interval||_MAX_POINT_INTERVAL_MS,e.markers=this._merge_objs(_DEFAULT_MARKERS,e.markers||{}),e.marker_options=this._merge_objs(_DEFAULT_MARKER_OPTS,e.marker_options||{}),e.polyline_options=e.polyline_options||[],e.gpx_options=this._merge_objs(_DEFAULT_GPX_OPTS,e.gpx_options||{}),L.Util.setOptions(this,e),L.GPXTrackIcon=L.Icon.extend({options:e.marker_options}),this._gpx=t,this._layers={},this._prepare_markers(e.markers),this._init_info(),t&&this._parse(t,e,this.options.async)},get_duration_string:function(t,e){var n="",i=(_DAY_IN_MILLIS<=t&&(n+=Math.floor(t/_DAY_IN_MILLIS)+"d ",t%=_DAY_IN_MILLIS),_HOUR_IN_MILLIS<=t&&(n+=Math.floor(t/_HOUR_IN_MILLIS)+":",t%=_HOUR_IN_MILLIS),Math.floor(t/_MINUTE_IN_MILLIS)),i=(t%=_MINUTE_IN_MILLIS,i<10&&(n+="0"),n+=i+"'",Math.floor(t/_SECOND_IN_MILLIS));return t%=_SECOND_IN_MILLIS,i<10&&(n+="0"),n=(n+=i)+(!e&&0<t?"."+Math.round(1e3*Math.floor(t))/1e3:'"')},get_duration_string_iso:function(t,e){return this.get_duration_string(t,e).replace("'",":").replace('"',"")},to_miles:function(t){return t/1.60934},to_ft:function(t){return 3.28084*t},m_to_km:function(t){return t/1e3},m_to_mi:function(t){return t/1609.34},ms_to_kmh:function(t){return 3.6*t},ms_to_mih:function(t){return t/1609.34*3600},get_name:function(){return this._info.name},get_desc:function(){return this._info.desc},get_author:function(){return this._info.author},get_copyright:function(){return this._info.copyright},get_distance:function(){return this._info.length},get_distance_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))},get_start_time:function(){return this._info.duration.start},get_end_time:function(){return this._info.duration.end},get_moving_time:function(){return this._info.duration.moving},get_total_time:function(){return this._info.duration.total},get_moving_pace:function(){return this.get_moving_time()/this.m_to_km(this.get_distance())},get_moving_pace_imp:function(){return this.get_moving_time()/this.get_distance_imp()},get_moving_speed:function(){return this.m_to_km(this.get_distance())/(this.get_moving_time()/36e5)},get_moving_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_moving_time()/36e5)},get_total_speed:function(){return this.m_to_km(this.get_distance())/(this.get_total_time()/36e5)},get_total_speed_imp:function(){return this.to_miles(this.m_to_km(this.get_distance()))/(this.get_total_time()/36e5)},get_elevation_gain:function(){return this._info.elevation.gain},get_elevation_loss:function(){return this._info.elevation.loss},get_elevation_gain_imp:function(){return this.to_ft(this.get_elevation_gain())},get_elevation_loss_imp:function(){return this.to_ft(this.get_elevation_loss())},get_elevation_data:function(){var e=this;return this._info.elevation._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(0)+" m"})})},get_elevation_data_imp:function(){var e=this;return this._info.elevation._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,e.to_ft,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(0)+" ft"})})},get_elevation_max:function(){return this._info.elevation.max},get_elevation_min:function(){return this._info.elevation.min},get_elevation_max_imp:function(){return this.to_ft(this.get_elevation_max())},get_elevation_min_imp:function(){return this.to_ft(this.get_elevation_min())},get_speed_data:function(){var e=this;return this._info.speed._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,e.ms_to_kmh,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(2)+" km/h"})})},get_speed_data_imp:function(){var e=this;return this._info.speed._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,e.ms_to_mih,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(2)+" mi/h"})})},get_speed_max:function(){return 3600*this.m_to_km(this._info.speed.max)},get_speed_max_imp:function(){return this.to_miles(this.get_speed_max())},get_average_hr:function(){return this._info.hr.avg},get_average_temp:function(){return this._info.atemp.avg},get_average_cadence:function(){return this._info.cad.avg},get_heartrate_data:function(){var e=this;return this._info.hr._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(0)+" bpm"})})},get_heartrate_data_imp:function(){var e=this;return this._info.hr._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,null,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(0)+" bpm"})})},get_cadence_data:function(){var e=this;return this._info.cad._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(0)+" rpm"})})},get_temp_data:function(){var e=this;return this._info.atemp._points.map(function(t){return e._prepare_data_point(t,e.m_to_km,null,function(t,e){return t.toFixed(2)+" km, "+e.toFixed(0)+" degrees"})})},get_cadence_data_imp:function(){var e=this;return this._info.cad._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,null,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(0)+" rpm"})})},get_temp_data_imp:function(){var e=this;return this._info.atemp._points.map(function(t){return e._prepare_data_point(t,e.m_to_mi,null,function(t,e){return t.toFixed(2)+" mi, "+e.toFixed(0)+" degrees"})})},reload:function(){this._init_info(),this.clearLayers(),this._parse(this._gpx,this.options,this.options.async)},_merge_objs:function(t,e){var n,i={};for(n in t)i[n]=t[n];for(n in e)i[n]=e[n];return i},_prepare_data_point:function(t,e,n,i){e=[e&&e(t[0])||t[0],n&&n(t[1])||t[1]];return e.push(i&&i(e[0],e[1])||e[0]+": "+e[1]),e},_prepare_markers:function(n){function i(t){return new L.GPXTrackIcon({iconUrl:t})}return Object.entries(n).forEach(([t,e])=>{"wptIcons"===t||"wptTypeIcons"===t?n[t]=this._prepare_markers(e):"pointMatchers"===t?n[t]=e.map(t=>("string"==typeof t.icon&&(t.icon=i(t.icon)),t)):"string"==typeof e?n[t]=i(e):"object"==typeof e&&(n[t]=this._prepare_markers(e))}),n},_init_info:function(){this._info={name:null,length:0,elevation:{gain:0,loss:0,max:0,min:1/0,_points:[]},speed:{max:0,_points:[]},hr:{avg:0,_total:0,_points:[]},duration:{start:null,end:null,moving:0,total:0},atemp:{avg:0,_total:0,_points:[]},cad:{avg:0,_total:0,_points:[]}}},_load_xml:function(t,e,n,i){null==i&&(i=this.options.async),null==n&&(n=this.options);var o=new window.XMLHttpRequest;o.open("GET",t,i);try{o.overrideMimeType("text/xml")}catch(t){}o.onreadystatechange=function(){4==o.readyState&&200==o.status&&e(o.responseXML,n)},o.send(null)},_parse:function(t,e,n){function i(t,e){var n=a._parse_gpx_data(t,e);n?(a.addLayer(n),a.fire("loaded",{layers:n,element:t})):a.fire("error",{err:"No parseable layers of type(s) "+JSON.stringify(e.gpx_options.parseElements)})}var o,a=this;"<"===t.substr(0,1)?(o=new DOMParser,n?setTimeout(function(){i(o.parseFromString(t,"text/xml"),e)}):i(o.parseFromString(t,"text/xml"),e)):this._load_xml(t,i,e,n)},_parse_gpx_data:function(t,e){var n,i=[];0<(d=t.getElementsByTagName("name")).length&&(this._info.name=d[0].textContent);0<(x=t.getElementsByTagName("desc")).length&&(this._info.desc=x[0].textContent);var o=t.getElementsByTagName("author"),o=(0<o.length&&(this._info.author=o[0].textContent),t.getElementsByTagName("copyright")),o=(0<o.length&&(this._info.copyright=o[0].textContent),e.gpx_options.parseElements);if(-1<o.indexOf("route"))for(var a=t.getElementsByTagName("rte"),_=0;_<a.length;_++)var r=a[_],s=this._extract_styling(r),l=this._get_polyline_options(e.polyline_options,_),i=i.concat(this._parse_segment(a[_],e,s,l,"rtept"));if(-1<o.indexOf("track")){var m=t.getElementsByTagName("trk");for(_=0;_<m.length;_++){var p=m[_],s=this._extract_styling(p),l=this._get_polyline_options(e.polyline_options,_);if(e.gpx_options.joinTrackSegments)i=i.concat(this._parse_segment(p,e,s,l,"trkpt"));else for(var h=p.getElementsByTagName("trkseg"),g=0;g<h.length;g++)i=i.concat(this._parse_segment(h[g],e,s,l,"trkpt"))}}if(this._info.hr.avg=Math.round(this._info.hr._total/this._info.hr._points.length),this._info.cad.avg=Math.round(this._info.cad._total/this._info.cad._points.length),this._info.atemp.avg=Math.round(this._info.atemp._total/this._info.atemp._points.length),-1<o.indexOf("waypoint"))for(n=t.getElementsByTagName("wpt"),_=0;_<n.length;_++){var u,c=new L.LatLng(n[_].getAttribute("lat"),n[_].getAttribute("lon")),f=n[_].getElementsByTagName("name"),d=0<f.length?f[0].textContent:"",f=n[_].getElementsByTagName("desc"),x=0<f.length?f[0].textContent:"",f=n[_].getElementsByTagName("sym"),f=0<f.length?f[0].textContent:null,y=n[_].getElementsByTagName("type"),y=0<y.length?y[0].textContent:null,v=e.markers.wptIcons,I=e.markers.wptTypeIcons,N=e.markers.pointMatchers||[];if(v&&f&&v[f])u=v[f];else if(I&&y&&I[y])u=I[y];else if(0<N.length){for(var g=0;g<N.length;g++)if(N[g].regex.test(d)){u=N[g].icon;break}}else v&&v[""]&&(u=v[""]);u?((I=new L.Marker(c,{clickable:e.marker_options.clickable,title:d,icon:u,type:"waypoint"})).bindPopup("<b>"+d+"</b>"+(0<x.length?"<br>"+x:"")).openPopup(),this.fire("addpoint",{point:I,point_type:"waypoint",element:n[_]}),i.push(I)):console.log("No waypoint icon could be matched for symKey=%s,typeKey=%s,name=%s on waypoint %o",f,y,d,n[_])}return 1<i.length?new L.FeatureGroup(i):1==i.length?i[0]:void 0},_parse_segment:function(t,e,n,i,o){var a=t.getElementsByTagName(o);if(!a.length)return[];for(var _=[],r=[],s=[],l=null,m=0;m<a.length;m++){var p=new L.LatLng(a[m].getAttribute("lat"),a[m].getAttribute("lon")),h=(p.meta={time:null,ele:null,hr:null,cad:null,atemp:null,speed:null},0<(g=a[m].getElementsByTagName("time")).length?p.meta.time=new Date(Date.parse(g[0].textContent)):p.meta.time=new Date("1970-01-01T00:00:00"),null!=l?Math.abs(p.meta.time-l.meta.time):0),g=a[m].getElementsByTagName("ele"),u=(0<g.length?p.meta.ele=parseFloat(g[0].textContent):p.meta.ele=null!=l?l.meta.ele:null,null!=l?p.meta.ele-l.meta.ele:0),c=null!=l?this._dist3d(l,p):0;if(0<(g=a[m].getElementsByTagName("speed")).length?p.meta.speed=parseFloat(g[0].textContent):p.meta.speed=0<h?1e3*c/h:0,0<(g=a[m].getElementsByTagName("name")).length)for(var f=g[0].textContent,d=e.markers.pointMatchers||[],x=0;x<d.length;x++)if(d[x].regex.test(f)){r.push({label:f,coords:p,icon:d[x].icon,element:a[m]});break}this._info.length+=c,0<(g=a[m].getElementsByTagNameNS("*","hr")).length&&(p.meta.hr=parseInt(g[0].textContent),this._info.hr._points.push([this._info.length,p.meta.hr]),this._info.hr._total+=p.meta.hr),0<(g=a[m].getElementsByTagNameNS("*","cad")).length&&(p.meta.cad=parseInt(g[0].textContent),this._info.cad._points.push([this._info.length,p.meta.cad]),this._info.cad._total+=p.meta.cad),0<(g=a[m].getElementsByTagNameNS("*","atemp")).length&&(p.meta.atemp=parseInt(g[0].textContent),this._info.atemp._points.push([this._info.length,p.meta.atemp]),this._info.atemp._total+=p.meta.atemp),p.meta.ele>this._info.elevation.max&&(this._info.elevation.max=p.meta.ele),p.meta.ele<this._info.elevation.min&&(this._info.elevation.min=p.meta.ele),this._info.elevation._points.push([this._info.length,p.meta.ele]),p.meta.speed>this._info.speed.max&&(this._info.speed.max=p.meta.speed),this._info.speed._points.push([this._info.length,p.meta.speed]),null==l&&null==this._info.duration.start&&(this._info.duration.start=p.meta.time),this._info.duration.end=p.meta.time,this._info.duration.total+=h,h<e.max_point_interval&&(this._info.duration.moving+=h),0<u?this._info.elevation.gain+=u:this._info.elevation.loss+=Math.abs(u),_.push(l=p)}o=new L.Polyline(_,this._extract_styling(t,n,i));this.fire("addline",{line:o,element:t}),s.push(o),e.markers.startIcon&&(y=new L.Marker(_[0],{clickable:e.marker_options.clickable,icon:e.markers.startIcon}),this.fire("addpoint",{point:y,point_type:"start",element:a[0]}),s.push(y)),e.markers.endIcon&&(y=new L.Marker(_[_.length-1],{clickable:e.marker_options.clickable,icon:e.markers.endIcon}),this.fire("addpoint",{point:y,point_type:"end",element:a[a.length-1]}),s.push(y));for(m=0;m<r.length;m++){var y=new L.Marker(r[m].coords,{clickable:e.marker_options.clickable,title:r[m].label,icon:r[m].icon});this.fire("addpoint",{point:y,point_type:"label",element:r[m].element}),s.push(y)}return s},_get_polyline_options:function(t,e){return Array.isArray(t)?t[e]||{}:t},_extract_styling:function(t,e,n){var i,e=this._merge_objs(_DEFAULT_POLYLINE_OPTS,e),t=t.getElementsByTagNameNS(_GPX_STYLE_NS,"line");return 0<t.length&&(0<(i=t[0].getElementsByTagName("color")).length&&(e.color="#"+i[0].textContent),0<(i=t[0].getElementsByTagName("opacity")).length&&(e.opacity=i[0].textContent),0<(i=t[0].getElementsByTagName("weight")).length&&(e.weight=i[0].textContent),0<(i=t[0].getElementsByTagName("linecap")).length&&(e.lineCap=i[0].textContent),0<(i=t[0].getElementsByTagName("linejoin")).length&&(e.lineJoin=i[0].textContent),0<(i=t[0].getElementsByTagName("dasharray")).length&&(e.dashArray=i[0].textContent),0<(i=t[0].getElementsByTagName("dashoffset")).length&&(e.dashOffset=i[0].textContent)),this._merge_objs(e,n)},_dist2d:function(t,e){var n=this._deg2rad(e.lat-t.lat),i=this._deg2rad(e.lng-t.lng),n=Math.sin(n/2)*Math.sin(n/2)+Math.cos(this._deg2rad(t.lat))*Math.cos(this._deg2rad(e.lat))*Math.sin(i/2)*Math.sin(i/2);return 6371e3*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))},_dist3d:function(t,e){var n=this._dist2d(t,e),e=Math.abs(e.meta.ele-t.meta.ele);return Math.sqrt(Math.pow(n,2)+Math.pow(e,2))},_deg2rad:function(t){return t*Math.PI/180}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=L:"function"==typeof define&&define.amd&&define(L);