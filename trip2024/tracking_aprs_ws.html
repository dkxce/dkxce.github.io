<html>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script src="js/leaflet.js"></script>
	<script src="js/coords.js"></script>
	<script src="js/leaflet.hotline.js"></script>
	<script src="js/yandex.js"></script>
	<script src="https://unpkg.com/leaflet-kmz@latest/dist/leaflet-kmz.js"></script>
	<script type="text/javascript">
		/*
			$(document).ready(function() {
				[
					'https://api-maps.yandex.ru/2.0/?load=package.map&lang=ru_RU'
					// 'https://api-maps.yandex.ru/2.0/?load=package.standard&lang=ru-RU'
					// 'https://api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU'
				].forEach(function(src) {
					setTimeout(function() {
						var script = document.createElement('script');
						script.src = src;
						script.async = false;
						document.head.appendChild(script);
					}, 1000);
				});
			});
		*/
	</script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
	<style>		
		body { padding: 0 0 0 0; margin: 0px; }
		#map {width: 100%; height: 100%; padding: 0px; margin: 0px; }
		#top {width: 400px; height:24px; position: absolute; left: 70px; top: 8px; z-index: 1001; font-weight: bold; }
		.aprs-icon { 
			position: relative; 
			top: 12px; left: -12px; width: 24px; height: 24px;
			background: url('icons/aprs-symbols-24-0.png');
			color: white;
			font-weight: bold; text-align: center; vertical-align: middle; font-size: 14px; padding-left: 0.5px; padding-top: 1px;
		}
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="top">
		<a href="tracking.html">Tracking</a> |
		<a href="tracking_aprs.html">Tracking APRS</a>
	</div>
	<script>
		var tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png');
		var map = L.map('map', {layers: [tiles], scrollWheelZoom: true, dragging: true, tap: false });		
		map.setView(new L.LatLng(50.55,37.55), 8);		
		
		var osmgerman = L.tileLayer('http://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Maps &copy; <a href="http://openstreetmap.org">OSM</a>', subdomains: ['a','b','c'] });		
		var osmhot = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Maps &copy; <a href="http://openstreetmap.org">OSM</a>', subdomains: ['a','b','c'] });		
		var opentopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var cyclemap = L.tileLayer('https://{s}.tile.hosted.thunderforest.com/cycle/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var mtbmap = L.tileLayer('https://tile.mtbmap.cz/mtbmap_tiles/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var outdoor = L.tileLayer('https://a.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var dvagis = L.tileLayer('https://tile{s}.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=1.1', { maxZoom: 18, subdomains: ['0','1','2','3'] });			
		var thunderforest = L.tileLayer('https://a.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', { maxZoom: 18, subdomains: ['a','b','c'] });	
		
		var osmWikiMapTiles = L.tileLayer('', { maxZoom: 17, attribution: 'Maps &copy; WikiMapia' });
		osmWikiMapTiles.getTileUrl = function (tilePoint, zoom) { return "http://i" + ((tilePoint.x % 4) + (tilePoint.y % 4)*4) + ".wikimapia.org/?lng=1&" + 'x=' + tilePoint.x + '&y='+tilePoint.y+'&zoom='+tilePoint.z; };
		
		var GoogleMapLayer = new L.TileLayer('http://{s}.google.com/vt/lyrs=m@177000000&hl=ru&src=app&x={x}&s=&y={y}&z={z}&s=Ga', {attribution: 'Data, imagery and map information provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], zIndex: 2});
		var GoogleMapOverlayLayer = new L.TileLayer('http://{s}.google.com/vt/lyrs=h@177000000&hl=ru&src=app&x={x}&s=&y={y}&z={z}&s=G', {attribution: 'Data, imagery and map information provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], zIndex: 4});
		var GoogleTrafficLayer = new L.TileLayer('http://{s}.google.com/vt?hl=ru&src=app&lyrs=m@177000000,traffic|seconds_into_week:-1&x={x}&s=&y={y}&z={z}&style=15', {attribution: 'Traffic data provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], traffic: true, zIndex: 21});
		
		var ESRI = new L.TileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png', { attribution: ' © <a href="https://www.arcgis.com/features/">ArcGIS</a>', lttype: 'ESRI' });
		var ESRISat = new L.TileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png', { attribution: ' © <a href="https://arcgisonline.com">ArcGIS</a>', lttype: 'ESRISat' });

		/*
		var yndx = new L.Yandex();
		var yndxS = new L.Yandex("satellite");
		var yndxH = new L.Yandex("hybrid");
		var yndxN = new L.Yandex("publicMap");
		var ytraffic = new L.Yandex("null", {traffic:true, opacity:0.8, overlay:true});
		*/
				
		var basemaps = {					
					  "OSM Mapnik": tiles, 
					  "OSM German Style": osmgerman, 
					  "OSM Hot Style": osmhot,
					  'OpenTopoMap': opentopo,
					  'OpenCycleMap': cyclemap,
					  'MTB': mtbmap,
					  'Outdoor': outdoor,
					  "2GIS": dvagis,
					  "ThunderForest": thunderforest,
					  "WikiMapia": osmWikiMapTiles,
					  "Google (Maps)": GoogleMapLayer,
					  /*
					  "Yandex (Maps)": yndxN,
					  "Yandex (Sattelite)": yndxS,
					  "Yandex (Hybrid)": yndxH,
					  */
					  'ArcGIS ESRI (Maps)': ESRI, 
					  'ArcGIS ESRI (Sattelite)': ESRISat, 
				  };
		var overlays = {
					  "Google (Hybrid)": GoogleMapOverlayLayer,
					  "Google (Traffic)": GoogleTrafficLayer,
					  /*
					  "Yandex (Traffic)": ytraffic,		
					  */
				  };
		L.control.layers(basemaps, overlays, { collapsed: true }).addTo(map);		
		var control = L.control.layers(null, null, { collapsed: false }).addTo(map);
				
		var kmz = L.kmzLayer().addTo(map); // https://github.com/Raruto/leaflet-kmz
		kmz.on('load', function(e) { map.fitBounds(e.layer.getBounds()); control.addOverlay(e.layer, '(KMZ) ' + e.name); });		
		
		try { var hash = window.location.hash.substr(1); if (hash != '') kmz.load('kmz/' + hash); } catch (e) {};
		
		// LOAD kmz
		kmz.load('kmz/Bike_Trips_2024.kmz');
		kmz.load('kmz/tracks.skif4x4.ru.kmz');
		kmz.load('kmz/Veloradar.kmz');
		kmz.load('kmz/gfisht.kmz');
		kmz.load('kmz/Shaumyan.kmz');
		
		var carIcon = L.icon({ iconUrl: 'icons/car.png', iconSize: [32, 32], iconAnchor: [16,  16] });
		var markerOptions = { title: 'I am', clickable: true, draggable: false, icon: carIcon, rotationAngle: 0, };
		var mypos = null;
		var follow = true;
		if ("geolocation" in navigator) 
		{
			var getPos = function() 
			{
				navigator.geolocation.getCurrentPosition((position) => 
				{
				  if (mypos == null)
				  {
					mypos = L.marker([position.coords.latitude,position.coords.longitude], markerOptions);
					mypos.addTo(map).bindPopup('Me');
					control.addOverlay(mypos, 'I am (Navigate)');					
					map.setView(new L.LatLng(position.coords.latitude,position.coords.longitude), map.getZoom());					
					$('.leaflet-control-layers-selector').change(function() {
						if ($(this).parent().text().includes('I am')) 
						{
							follow = $(this).prop('checked');
							if (follow) map.setView(mypos.getLatLng());
						};
					});
				  }
				  else
				  {
				    if (Number.isNaN(position.coords.heading)) mypos.options.rotationAngle = position.coords.heading - 90;
					mypos.setLatLng([position.coords.latitude,position.coords.longitude]); 
					if (follow) map.setView(new L.LatLng(position.coords.latitude,position.coords.longitude), map.getZoom());						
				  };
				});
				setTimeout(getPos, 2000);
			};
			getPos();
		};
		
		var aprsMarkers = {};
		var aprsLayer = L.layerGroup([]);
		aprsLayer.addTo(map);
		control.addOverlay(aprsLayer, 'APRS Objects');	
		
		var symbolToImage = function(symb)
		{
			var prose = 'primary';
			var label = '';
			if(symb.length == 2)
			{
				if(symb[0] == '\\') prose = 'secondary';
				else if ((symb[0] != '/') && (("#&0>AW^_acnsuvz").indexOf(symb[1]) >= 0))
                {
                    prose = "secondary";
                    label = symb[0].toString();
					if (("#0A^cv").indexOf(symb[1]) >= 0) 
						{ label = "<span style=\"color:black;\">" + label + "</span>"; };
                };
				symb = symb.substr(1);
			};
			var symbtable = '!"#$%&\'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~';						
			var idd = symbtable.indexOf(symb);
			if (idd < 0) idd = 14;
			var itop =  Math.floor(idd / 16) * 24;
			var ileft = (idd % 16) * 24;
			return 'url(icons/'+prose+'.png) -'+ileft+'px -'+itop+'px no-repeat';
		};
		
		var wsocket = null;
		var initSocket = function()
		{
			wsocket = new WebSocket('wss://aprs-map.info:9001/ws');			
			wsocket.onopen = (event) => {
				var bnds = map.getBounds();
				var payload = {"payload_request_type":1,"neLat":bnds._northEast.lat,"neLng":bnds._northEast.lng,"swLat":bnds._southWest.lat,"swLng":bnds._southWest.lng,"minutes":360,"time":null,"onlyLatestPacket":0};
				try { wsocket.send(JSON.stringify(payload)); } catch (e) {};
			};
			wsocket.onmessage = (event) =>
			{
				if (event.data == null) return;
				var data = null;
				try { data = JSON.parse(event.data); } catch (e) { return; };
				if (data.payload_response_type == undefined) return;
				try
				{
					data = data.data;
				}
				catch (e) {};
				if (typeof data != 'object') return;
				if (!Array.isArray(data)) data = [data];
				try
				{
					for (let i in data) 
					{
						  let value = data[i];
						  if (value.id == undefined) continue;
						  let key = value.station_name == undefined || value.station_name == null ? value.sender_name : value.station_name;
						  let received = value.position_timestamp  == undefined || value.position_timestamp == null ? value.timestamp : value.position_timestamp;
						  received = (new Date(received * 1000)).toISOString();
						  
						  if (aprsMarkers[key] == undefined)
						  {
							var bgnd = symbolToImage(value['symbol']);
							var smb = '/\\&_%-abcdefghijklmnopqrstuvwxyz'.includes(value['symbol'][0]) ? '' : value['symbol'][0];
							var icon = new L.DivIcon({ className: 'my-div-icon',  html: '<div class="aprs-icon" style="background:' + bgnd + ';">' + smb + '</div>', })
							var opts = { title: key, clickable: true, draggable: false, icon: icon };
							aprsMarkers[key] = L.marker([value.latitude,value.longitude], opts);
							aprsMarkers[key].bindPopup('<b>' + key + '</b><small style="color:gray;"><br/>' + value['comment'] + '<br/>' + received + '</small>');
							aprsLayer.addLayer(aprsMarkers[key]);
						  }
						  else
						  {
							aprsMarkers[key].setPopupContent('<b>' + key + '</b><small style="color:gray;"><br/>' + value['comment'] + '<br/>' + received + '</small>');
							aprsMarkers[key].setLatLng([value.latitude,value.longitude]); 
						  };
					};	
				} catch (e) {};
			};
			wsocket.onclose = (event) => { wsocket = null; setTimeout(initSocket, 10000); };
			wsocket.onerror = (event) => {};
		};
		initSocket();
		map.on('moveend', function() { 
			 if (wsocket == null) return;
			 var bnds = map.getBounds();
			 var payload = {"payload_request_type":1,"neLat":bnds._northEast.lat,"neLng":bnds._northEast.lng,"swLat":bnds._southWest.lat,"swLng":bnds._southWest.lng,"minutes":360,"time":null,"onlyLatestPacket":0};
			 try { wsocket.send(JSON.stringify(payload)); } catch (e) {};
		});
	</script>
</body>
</html>