<html>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<script src="js/leaflet.js"></script>
	<script src="js/coords.js"></script>
	<script src="js/leaflet.hotline.js"></script>
	<script src="js/gpx.min_075.js"></script>
	<script src="https://unpkg.com/leaflet-kmz@latest/dist/leaflet-kmz.js"></script>
	<script src="js/leaflet.polylineDecorator.js"></script>
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
	<style>		
		body { padding: 0 0 0 0; margin: 0px; }
		#map {width: 100%; height: 100%; padding: 0px; margin: 0px; }
		#top {width: 400px; height:24px; position: absolute; left: 70px; top: 8px; z-index: 1001; font-weight: bold; }
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="top"></div>
	<script>
		// icons: https://www.flaticon.com/free-icons/temperature
		
		var tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png');
		var map = L.map('map', {layers: [tiles], scrollWheelZoom: true, dragging: true, tap: false });		
		map.setView(new L.LatLng(50.55,37.55), 8);		
		
		var osmgerman = L.tileLayer('http://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Maps &copy; <a href="http://openstreetmap.org">OSM</a>', subdomains: ['a','b','c'] });		
		var osmhot = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { maxZoom: 17, attribution: 'Maps &copy; <a href="http://openstreetmap.org">OSM</a>', subdomains: ['a','b','c'] });		
		var opentopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var cyclemap = L.tileLayer('https://{s}.tile.hosted.thunderforest.com/cycle/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var mtbmap = L.tileLayer('https://tile.mtbmap.cz/mtbmap_tiles/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var outdoor = L.tileLayer('https://a.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', { maxZoom: 17, opacity: 1});
		var dvagis = L.tileLayer('https://tile{s}.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=1.1', { maxZoom: 18, subdomains: ['0','1','2','3'] });			
		var thunderforest = L.tileLayer('https://a.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png', { maxZoom: 18, subdomains: ['a','b','c'] });	
		
		var osmWikiMapTiles = L.tileLayer('', { maxZoom: 17, attribution: 'Maps &copy; WikiMapia' });
		osmWikiMapTiles.getTileUrl = function (tilePoint, zoom) { return "http://i" + ((tilePoint.x % 4) + (tilePoint.y % 4)*4) + ".wikimapia.org/?lng=1&" + 'x=' + tilePoint.x + '&y='+tilePoint.y+'&zoom='+tilePoint.z; };
		
		var GoogleMapLayer = new L.TileLayer('http://{s}.google.com/vt/lyrs=m@177000000&hl=ru&src=app&x={x}&s=&y={y}&z={z}&s=Ga', {attribution: 'Data, imagery and map information provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], zIndex: 2});
		var GoogleMapOverlayLayer = new L.TileLayer('http://{s}.google.com/vt/lyrs=h@177000000&hl=ru&src=app&x={x}&s=&y={y}&z={z}&s=G', {attribution: 'Data, imagery and map information provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], zIndex: 4});
		var GoogleTrafficLayer = new L.TileLayer('http://{s}.google.com/vt?hl=ru&src=app&lyrs=m@177000000,traffic|seconds_into_week:-1&x={x}&s=&y={y}&z={z}&style=15', {attribution: 'Traffic data provided by <a href="http://maps.google.com" target="_blank">Google</a>', maxZoom: 19, subdomains: ['mts0','mts1'], traffic: true, zIndex: 21});
		
		var ESRI = new L.TileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png', { attribution: ' © <a href="https://www.arcgis.com/features/">ArcGIS</a>', lttype: 'ESRI' });
		var ESRISat = new L.TileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png', { attribution: ' © <a href="https://arcgisonline.com">ArcGIS</a>', lttype: 'ESRISat' });
		
		var basemaps = {					
					  "OSM Mapnik": tiles, 
					  "OSM German Style": osmgerman, 
					  "OSM Hot Style": osmhot,
					  'OpenTopoMap': opentopo,
					  'OpenCycleMap': cyclemap,
					  'MTB': mtbmap,
					  'Outdoor': outdoor,
					  "2GIS": dvagis,
					  "ThunderForest": thunderforest,
					  "WikiMapia": osmWikiMapTiles,
					  "Google (Maps)": GoogleMapLayer,
					  'ArcGIS ESRI (Maps)': ESRI, 
					  'ArcGIS ESRI (Sattelite)': ESRISat, 
				  };
		var overlays = {
					  "Google (Hybrid)": GoogleMapOverlayLayer,
					  "Google (Traffic)": GoogleTrafficLayer,				  
				  };
		L.control.layers(basemaps, overlays, { collapsed: true }).addTo(map);		
		var control = L.control.layers(null, null, { collapsed: false }).addTo(map);
			
		var kmz = L.kmzLayer().addTo(map); // https://github.com/Raruto/leaflet-kmz
		kmz.on('load', function(e) {
			var bounds = e.layer.getBounds();
			 map.fitBounds(bounds);
			control.addOverlay(e.layer, e.name);
		});		
			
		var marker = null;
		var narodmon = null;
		var hotlineLayer = null;
		var lstpos = null;
		var lstspd = 0;
		var wthpos = [0,0];
		const params = new Proxy(new URLSearchParams(window.location.search), { get: (searchParams, prop) => searchParams.get(prop), });			
		var who = params.who != null ? params.who : window.location.hash.substr(1);	
		var nme = params.nme != null ? params.nme : who;
		try
		{
			
			var reload = function()
			{	
				let url = 'https://livegpstracks.com/viewer_coos_s.php?code=' + who + '&random=' + Math.random().toString();
				url = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
				setTimeout(reload,15000);
				$.getJSON(url, function (data) 
				{
					 var jObj = JSON.parse(data.contents)[0];
					 if (lstpos == null || (lstpos.lat != jObj.lat && lstpos.lat != jObj.lng))
					 {
						 lstpos = new L.LatLng(jObj.lat, jObj.lng);					 
						 lstspd = jObj.speed;
						 let popupText = '<span style="color:blue;"><b>' + jObj.speed.toString() + ' km/h</b></span> <span style="color:maroon;">' + jObj.t + '</span> ' + jObj.d + ' <b>' + nme + '</b>';
						 if (marker == null)
						 {
							 map.setView(lstpos, 14);	
							 var carIcon = L.icon({ iconUrl: 'icons/car.png', iconSize: [32, 32],iconAnchor: [16,  16] });
							 var tempIcon = L.icon({ iconUrl: 'icons/temperature.png', iconSize: [32, 32],iconAnchor: [16,  16] });
							 var humiIcon = L.icon({ iconUrl: 'icons/humidity.png', iconSize: [32, 32],iconAnchor: [16,  16] });
							 var markerOptions = { title: nme == who ? "Location" : nme, clickable: true, draggable: false, icon: carIcon, rotationAngle: jObj.azimuth - 90, };
							 marker = L.marker(lstpos, markerOptions);
							 marker.bindPopup(popupText); // .openPopup();
							 marker.addTo(map);
							 control.addOverlay(marker, nme + ' (CAR)');						 						
						 }
						 else 
						 {
							 marker.options.rotationAngle = jObj.azimuth - 90;
							 marker.setLatLng(lstpos); 
							 marker.setPopupContent(popupText); // .openPopup();
							 if (document.hidden) map.setView(lstpos, 14);
						 };
						 $('#top')[0].innerHTML = (popupText);
						 if (hotlineLayer != null) hotlineLayer.addLatLng([jObj.lat, jObj.lng, jObj.speed]);

						 // narodmon
						 let dst = getDistance(lstpos.lat, lstpos.lng, wthpos[0], wthpos[1]);
						 if (dst > 5.5)
						 { 
							 let nmurl = 'http://narodmon.ru/api/sensorsNearby?lat='+lstpos.lat+'&lng='+lstpos.lng+'&radius=10&types=1,2&uuid=ab4ec47e07ba86074d59f6b7d86fafff&api_key=k69KecaSFegvV&lang=ru';
							 nmurl = 'https://driver-updater.com/api/v1/front/proxyquery/?rnd='+Math.random()+'&My-Proxy-Query=' + btoa(nmurl);	
							 $.getJSON(nmurl, function (data) 
							 {
								try
								{
									let devices = data.devices;
									let markers = [];
									for (let i = 0; i < devices.length; i++)
										for (j = 0; j < devices[i].sensors.length; j++)
										{
											if (devices[i].sensors[j].type != 1 && devices[i].sensors[j].type != 2) continue;
											let title = devices[i].sensors[j].value + devices[i].sensors[j].unit + ' (' + devices[i].sensors[j].name + ')';
											let mIcon = devices[i].sensors[j].type == 2 ? humiIcon : tempIcon;
											let tMarker = L.marker([devices[i].lat,devices[i].lon], { title: title, clickable: true, draggable: false, icon: mIcon, });
											tMarker.bindPopup(title);
											markers.push(tMarker);
										};
									if (markers.length > 0)
									{
										wthpos = [lstpos.lat, lstpos.lng];
										if (narodmon == null)
										{
											narodmon = L.layerGroup(markers);
											marker.addTo(narodmon);
											control.addOverlay(narodmon, 'Weather (Pogoda)');
										}
										else 
											for (let k = 0; k < markers.length; k++)
												narodmon.addLayer(markers[k]);
									};
								} catch (e) {};
							 });
						};
					}
					else
					{
						let popupText = '<span style="color:blue;"><b>' + jObj.speed.toString() + ' km/h</b></span> <span style="color:maroon;">' + jObj.t + '</span> ' + jObj.d + ' <b>' + nme + '</b>';
						popupText += '</br><span style="font-size:11px;">(Updated '+(new Date()).toISOString()+')</span>';
						$('#top')[0].innerHTML = (popupText);
					};
				});
			};
			reload();
			
			var getTrack = function()
			{
				let today = (new Date()).toISOString();
				today = today.substring(8, 10) + '.' + today.substring(5, 7) + '.' + today.substring(0, 4);
				let turl = 'https://livegpstracks.com/viewer_coos_track_more.php?f=' + who + '&t=' + today + '&random=' + Math.random().toString();
                turl = 'https://driver-updater.com/api/v1/front/proxyquery/?rnd='+Math.random()+'&My-Proxy-Query=' + btoa(turl);				
				$.getJSON(turl, function (data) 
				{
					try
					{
						let jObjs = data; // JSON.parse(data.contents);
						if (jObjs.length > 1)
						{
							let coords = [];
							let lst = null;
							for (let i = 0; i < jObjs.length; i++) 
							{
								coords.push([jObjs[i].lat,jObjs[i].lng,jObjs[i].speed]);
								lst = [jObjs[i].lat,jObjs[i].lng];
							};
							coords.push([lstpos.lat,lstpos.lng,lstspd]);
							
							hotlineLayer = L.hotline(coords, { min: 0, max: 150,
							   palette: { 0.0: '#FF0000', 0.25: '#FFFF00', 0.45: '#00FF00', 0.6: '#C0FF00', 0.75: '#A2D2FF', 0.9: '#BDE0FE', 1.0: '#EDF2F4' },
							   weight: 8, outlineColor: '#000000', outlineWidth: 1
							});
							
							hotlineLayer.addTo(map);
							control.addOverlay(hotlineLayer, nme + ' (TRACK)');

							let decorator = L.polylineDecorator(hotlineLayer, {
								patterns: [{offset: 0, repeat: 30, symbol: L.Symbol.arrowHead({pixelSize: 7, pathOptions: { fillOpacity: 0.75, weight: 0, color: 'black' }})}]
							});
							decorator.addTo(map);
							control.addOverlay(decorator, nme + ' (ARROWS)');
						};
					} catch (e) {};
				});
			};
			getTrack();
		} catch (e) {};	

		var getDistance = function(lat1, lon1, lat2, lon2) 
		{
			let toRad = (v) => v * Math.PI / 180;	
			
			var R = 6378.137; // km
			var dLat = toRad(lat2 - lat1);
			var dLon = toRad(lon2 - lon1);
			var lat1 = toRad(lat1);
			var lat2 = toRad(lat2);

			var a = Math.sin(dLat/2) * Math.sin(dLat/2.0) + Math.sin(dLon/2.0) * Math.sin(dLon/2.0) * Math.cos(lat1) * Math.cos(lat2); 
			var c = 2.0 * Math.atan2(Math.sqrt(a), Math.sqrt(1.0-a)); 
			var d = R * c;
			return d;
		};	
		
		try
		{
			alert(window.Telegram.WebApp.initData);
			alert(window.Telegram.WebApp.version);
			alert(window.Telegram.WebApp.platform);
			alert(window.Telegram.WebApp.isExpanded);
			window.Telegram.WebApp.BackButton.show();
			window.Telegram.WebApp.MainButton.show();
		}
		catch (e) {};
	</script>
</body>
</html>